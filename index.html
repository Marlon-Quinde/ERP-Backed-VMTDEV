<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Registro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;       /* slate-900 */
      --card:#111827;     /* gray-900 */
      --muted:#94a3b8;    /* slate-400 */
      --text:#e5e7eb;     /* gray-200 */
      --primary:#38bdf8;  /* sky-400 */
      --primary-700:#0ea5e9;
      --success:#10b981;  /* emerald-500 */
      --error:#ef4444;    /* red-500 */
      --ring: #7dd3fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;
      background: radial-gradient(80vw 80vh at 50% -10%, #1e293b 0%, #0b1222 40%, var(--bg) 70%);
      color:var(--text); min-height:100svh; display:grid; place-items:center; padding:24px;
    }
    .card{
      width:100%; max-width:440px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(125,211,252,.15); border-radius:20px; padding:24px 22px 22px;
      box-shadow: 0 30px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    h1{margin:0 0 8px; font-size:20px; letter-spacing:.2px}
    p.sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .field{margin:12px 0}
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    input, select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(148,163,184,.25);
      background:#0b1222; color:var(--text); outline:none; transition:.15s border-color, .15s box-shadow;
    }
    input:focus, select:focus{
      border-color:var(--ring); box-shadow:0 0 0 4px rgba(125,211,252,.15);
    }
    .row{display:flex; gap:12px}
    .row .field{flex:1}
    .actions{margin-top:16px; display:flex; align-items:center; gap:10px}
    button{
      appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:600;
      background:linear-gradient(180deg, var(--primary), var(--primary-700));
      color:#05243a; box-shadow: 0 8px 20px rgba(56,189,248,.25);
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .msg{margin-top:14px; padding:10px 12px; border-radius:12px; font-size:14px; display:none}
    .msg.show{display:block}
    .msg.ok{background: rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.35); color:#d1fae5}
    .msg.err{background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); color:#fee2e2}
    .spinner{
      width:18px; height:18px; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%;
      display:none; animation:spin 1s linear infinite;
    }
    .spinner.show{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{margin-top:8px; font-size:12px; color:var(--muted)}
    .foot{margin-top:18px; font-size:12px; color:var(--muted)}
    a{color:var(--ring); text-decoration:none}
  </style>
</head>
<body>
  <form class="card" id="registerForm" autocomplete="on" novalidate>
    <h1>Crear cuenta</h1>
    <p class="sub">Completa los datos para registrarte.</p>

    <div class="field">
      <label for="name">Nombre</label>
      <input id="name" name="name" type="text" minlength="3" maxlength="60" placeholder="Tu nombre"
             required value="Jose44444444444"/>
    </div>

    <div class="field">
      <label for="email">Correo</label>
      <input id="email" name="email" type="email" inputmode="email" placeholder="tucorreo@ejemplo.com"
             required value="jose@hola.com"/>
    </div>

    <div class="row">
      <div class="field">
        <label for="password">Contraseña</label>
        <input id="password" name="password" type="password" minlength="2" maxlength="100" placeholder="••••••"
               required value="12"/>
        <div class="hint"><input type="checkbox" id="togglePwd"> <label for="togglePwd">Mostrar</label></div>
      </div>
      <div class="field">
        <label for="companyId">Company ID</label>
        <!--<input id="companyId" name="companyId" type="number" min="1" step="1" required value="2"/>-->
        <select id="companyId" name="companyId" required>
          <option value="" disabled>Selecciona una opción</option>
          <option value="1">Jams</option>
          <option value="2" selected>Jams2</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="submitBtn" type="submit">Registrar</button>
      <div class="spinner" id="spinner" aria-hidden="true"></div>
    </div>

    <div id="msg" class="msg" role="status" aria-live="polite"></div>
    <div class="foot">
      Endpoint: <code>https://localhost:7182/api/Security/Authentication/Register</code>
    </div>
  </form>

  <script>
    // ==== Config ====
    const ENDPOINT = 'https://localhost:7182/api/Security/Authentication/Register';

    // ==== Helpers ====
    const $ = (sel) => document.querySelector(sel);
    const msgBox = $('#msg');
    const btn = $('#submitBtn');
    const spinner = $('#spinner');

    function setLoading(isLoading){
      btn.disabled = isLoading;
      spinner.classList.toggle('show', isLoading);
    }

    function showMsg(text, ok=false){
      msgBox.textContent = text;
      msgBox.className = 'msg show ' + (ok ? 'ok' : 'err');
    }

    function extractErrorText(body){
      // Intenta leer varios formatos de error comunes en .NET / APIs
      if (!body) return 'Error desconocido.';
      if (typeof body === 'string') return body;

      // ASP.NET ProblemDetails
      if (body.title || body.detail) {
        const errorsObj = body.errors && typeof body.errors === 'object'
          ? Object.entries(body.errors).map(([k, v]) => `${k}: ${Array.isArray(v)? v.join(', ') : v}`).join(' | ')
          : '';
        return [body.title, body.detail, errorsObj].filter(Boolean).join(' — ');
      }

      // Campos comunes
      for (const key of ['message','error','errorMessage','msg']) {
        if (body[key]) return body[key];
      }

      try {
        return JSON.stringify(body);
      } catch {
        return 'Error en la solicitud.';
      }
    }

    // Mostrar/ocultar contraseña
    $('#togglePwd').addEventListener('change', (e)=>{
      $('#password').type = e.target.checked ? 'text' : 'password';
    });

    // ==== Submit ====
    $('#registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      msgBox.className = 'msg'; // limpia
      msgBox.textContent = '';

      const name = $('#name').value.trim();
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const companyId = Number($('#companyId').value);

      // Validación mínima en cliente
      if (!name || !email || !password || !companyId) {
        showMsg('Completa todos los campos.', false);
        return;
      }

      setLoading(true);
      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ name, email, password, companyId })
          // Si tu API usa cookies/sesión, agrega: credentials: 'include'
        });

        let data = null;
        const text = await res.text();
        try { data = text ? JSON.parse(text) : null; } catch { /* respuesta no-JSON */ }

        if (!res.ok) {
          const errText = extractErrorText(data) || `${res.status} ${res.statusText}`;
          showMsg(errText, false);
          return;
        }
        
        if(data.code !== 200){
          showMsg(data.message || 'Error en el registro.', false);
          return;
        }

        // Éxito
        showMsg('Registro completado correctamente.', true);
        // Opcional: muestra algo del payload si necesitas
        // console.log('Respuesta:', data);

        // Limpia el formulario si quieres
        // e.target.reset();

      } catch (err) {
        // Posibles causas: CORS, certificado no confiable, servidor caído
        showMsg('No se pudo conectar con la API. Revisa CORS/certificado y que el servidor esté activo.', false);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
